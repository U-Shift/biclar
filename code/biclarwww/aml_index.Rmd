---
title: "Resultados para a AML"
output:
  html_document:
    theme:
      bg: "#FFFFFF"
      fg: "#000000"
      highlight: "#000000"
      primary: "#000000"
      base_font:
        google: "Lexend"
      code_font:
        google: "JetBrains Mono"
    # toc: true
    # toc_float:
    #   toc_collapsed: true
    # toc_depth: 3
    css: css/style.css
    includes:
      after_body: img/footer.html
---

<!-- landing page for aml --> 

```{r setup, include=FALSE, cache=FALSE}
library(dplyr)
library(tmap)
tmap_mode("view")
library(leaflet)
library(ggplot2)
library(plotly)
library(scales)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) #to use the project root as the working directory

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      cache = TRUE, #hide if needed
                      warning = FALSE
                      )




fmt_num = function(x) format(round(sum(x)), big.mark=" ")
```

```{r chamadas}
i = "aml"
mun = "área metropolitana de Lisboa"

proposicao = "Na"
proposicaoD = "Da"
```

```{r dados}
TRIPSmode_municipio = readRDS(url("https://github.com/U-Shift/biclar/releases/download/0.0.1/TRIPSmode_municipal.Rds"))

TRIPSmode_municipio$modo[TRIPSmode_municipio$modo == "Car"] = "Automóvel"
TRIPSmode_municipio$modo[TRIPSmode_municipio$modo == "Bike"] = "Bicicleta"
TRIPSmode_municipio$modo[TRIPSmode_municipio$modo == "Motorcycle"] = "Motociclo"
TRIPSmode_municipio$modo[TRIPSmode_municipio$modo == "Walk"] = "A Pé"
TRIPSmode_municipio$modo[TRIPSmode_municipio$modo == "Transit"] = "Transportes Públicos"
TRIPSmode_municipio$modo[TRIPSmode_municipio$modo == "Other"] = "Outro"

TRIPSmode_aml = TRIPSmode_municipio %>%
  group_by(modo) %>%
  summarise(viagens = round(sum(viagens))) %>% 
  mutate(percentagem = round(100*viagens/sum(viagens),1))

TRIPSmode_aml_intr = TRIPSmode_municipio
TRIPSmode_aml_intr$Inter[TRIPSmode_aml_intr$Origem == TRIPSmode_aml_intr$Destino] = "Intramunicipal"
TRIPSmode_aml_intr$Inter[is.na(TRIPSmode_aml_intr$Inter)] = "Intermunicipal"
TRIPSmode_aml_intr = TRIPSmode_aml_intr %>% 
  group_by(modo, Inter) %>%
  summarise(viagens = round(sum(viagens)))

viagensinter = sum(TRIPSmode_aml_intr$viagens[TRIPSmode_aml_intr$Inter == "Intermunicipal"])
viagensintra = sum(TRIPSmode_aml_intr$viagens[TRIPSmode_aml_intr$Inter == "Intramunicipal"])

TRIPSmode_aml_intr$percentagem[TRIPSmode_aml_intr$Inter == "Intermunicipal"] =  round(100*TRIPSmode_aml_intr$viagens[TRIPSmode_aml_intr$Inter == "Intermunicipal"]/viagensinter, 1)

TRIPSmode_aml_intr$percentagem[TRIPSmode_aml_intr$Inter == "Intramunicipal"] =  round(100*TRIPSmode_aml_intr$viagens[TRIPSmode_aml_intr$Inter == "Intramunicipal"]/viagensintra, 1)

TRIPSmode_aml_intr = bind_rows(TRIPSmode_aml %>% mutate(Inter = "Todas"),  TRIPSmode_aml_intr)

```


```{r makemaps}

HEAT_aml_redux = readRDS(url("https://github.com/U-Shift/biclar/releases/download/0.0.1/HEAT_aml_123_redux.Rds"))

# cenario 1

  mapa11r = sf::st_read("export_rnet/rnet_aml_1404_100.gpkg", quiet = TRUE)
  mapa11r = mapa11r %>% 
    mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
  mapa11l = sf::st_read("export_rnet/rnet_aml_1304_100.gpkg", quiet = TRUE)
  mapa11l = mapa11l %>% 
    mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
  mapa12r = sf::st_read("export_rnet/rnet_aml_1410_100.gpkg", quiet = TRUE)
  mapa12r = mapa12r %>% 
    mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
  mapa12l = sf::st_read("export_rnet/rnet_aml_1310_100.gpkg", quiet = TRUE)
  mapa12l = mapa12l %>% 
    mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))


# cenario 2


mapa21r = sf::st_read("export_rnet/rnet_aml_2404_200.gpkg", quiet = TRUE)
mapa21r = mapa21r %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa21l = sf::st_read("export_rnet/rnet_aml_2304_200.gpkg", quiet = TRUE)
mapa21l = mapa21l%>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa22r = sf::st_read("export_rnet/rnet_aml_2410_200.gpkg", quiet = TRUE)
mapa22r = mapa22r %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa22l = sf::st_read("export_rnet/rnet_aml_2310_200.gpkg", quiet = TRUE)
mapa22l = mapa22l %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))



# cenario 3


mapa31r = sf::st_read("export_rnet/rnet_aml_3404_50.gpkg", quiet = TRUE)
mapa31r = mapa31r %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa31l = sf::st_read("export_rnet/rnet_aml_3304_50.gpkg", quiet = TRUE)
mapa31l = mapa31l %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa32r = sf::st_read("export_rnet/rnet_aml_3410_30.gpkg", quiet = TRUE)
mapa32r = mapa32r %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa32l = sf::st_read("export_rnet/rnet_aml_3310_30.gpkg", quiet = TRUE)
mapa32l = mapa32l %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
  
 
```

```{r minimos}

minimo1 = 100 

minimo2 = 200
 
minimo3 = 50

```


# `r mun`

## Cenário Base

Segundo o Inquérito à Mobilidade  ([IMOB](https://www.ine.pt/xportal/xmain?xpid=INE&xpgid=ine_publicacoes&PUBLICACOESpub_boui=349495406&PUBLICACOESmodo=2&xlang=pt){target="_blank"}) realizado em 2018 pelo INE, as viagens dentro da `r mun` têm as seguintes características.

```{r mododist, fig.ncol=2, out.width="50%"}
#gráfico com bistribuição de viagens por modo na AML segundo IMOB 2018

TRIPSmode_aml_intr$modo = factor(TRIPSmode_aml_intr$modo, 
                                 levels = c("Automóvel", "Transportes Públicos", "Motociclo", 
                                            "Outro", "A Pé", "Bicicleta"))


col_modes = c("#fe5f55", "#ffd166", "#8E794A", "grey", "#457b9d", "#90be6d") 

ggplot(TRIPSmode_aml_intr, aes(fill = modo, y = percentagem/100, x = Inter)) +
  geom_bar(position = position_fill(reverse = FALSE), stat = "identity") +
  scale_fill_manual(values = col_modes, name = "Modo") +
  scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = ifelse(percentagem > 6, paste0(percentagem,"%"), "")),
    position = position_stack(vjust = 0.5, reverse = FALSE))+
  theme_minimal() +
  theme(axis.title.y = element_blank(), axis.title.x = element_blank(), legend.title = element_blank(), legend.position = "none") +
  coord_flip()


ggplot(TRIPSmode_aml_intr, aes(fill = modo, y = viagens, x = Inter)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = col_modes, name = "Modo") +
  scale_y_continuous("Viagens / dia", labels = scales::comma_format(big.mark = ' ')) +
  geom_text(aes(label = ifelse(viagens > 500000, paste0(round(viagens/1000000,1)," M"), "")),
    position = position_stack(vjust = 0.5, reverse = FALSE))+
  theme_minimal() +
  theme(axis.title.y = element_blank(), legend.title = element_text("Modo"), legend.position = "right") +
  coord_flip()

```

Das cerca de `r round(sum(TRIPSmode_aml$viagens)/1000000,1)` milhões de viagens diárias `r stringr::str_to_lower(proposicao)` `r mun`, apenas `r TRIPSmode_aml[3,3]`% das viagens são realizadas em bicicleta (`r fmt_num(round(TRIPSmode_aml[3,2]))`). `r round(TRIPSmode_aml[2,2]/1000000,1)` milhões são feitas em automóvel (`r TRIPSmode_aml[2,3]`%), `r round(TRIPSmode_aml[1,2]/1000000,1)` milhões a pé (`r TRIPSmode_aml[1,3]`%), `r fmt_num(round(TRIPSmode_aml[6,2]/1000))`mil em Transportes Públicos (`r TRIPSmode_aml[6,3]`%) e `r round((TRIPSmode_aml[4,2]+TRIPSmode_aml[5,2])/1000)`mil em outros modos (`r TRIPSmode_aml[4,3]+TRIPSmode_aml[5,3]`%).

A figura seguinte mostra a proporção de viagens que é realizada com origem e destino no mesmo município (`r round(viagensintra/1000000,1)` milhões viagens), e as viagens com origem e destino em municípios diferentes (`r round(viagensinter/1000000,1)` milhões viagens). Como se pode observar, para todos os municípios, a maioria das viagens realizadas é intra municipal, emboras as viagens intermunicipais são bastante expressivas, principalmente em municípios como Odivelas, Oeiras, Amadora e Loures.

```{r circus, out.width="50%", fig.align='center'}
circus = "https://github.com/U-Shift/biclar/raw/master/man/figures/aml_circos.png"
knitr::include_graphics(circus, error = FALSE)
```

As metas da Estratégia Nacional de Mobilidade Ativa Ciclável ([ENMAC](https://files.dre.pt/1s/2019/08/14700/0004600081.pdf){target="_blank"}), estabelecem que dentro dos centros urbanos **4%** das viagens devem ser realizadas em bicicleta até 2024, e **10%** até 2030, e que as mesmas devem ser substituídas de viagens atualmente realizadas em automóvel.
Partindo do número de viagens realizadas em bicicleta em 2018 (cenário de referência, ou _cenário base_), é possível estimar o número de viagens com potencial para serem substituídas do automóvel para a bicicleta para cada cenário aqui avaliado.

O gráfico seguinte mostra o potencial de viagens a serem realizadas em bicicleta diariamente, por gama de distâncias de viagem, e para os cenários avaliados.

```{r plottly}
# gráfico com caracterização viagens IMOB intra municipais e intermonicipais

routes_13r_plot = readRDS("routes_13r_plot.Rds")


p2 = ggplot(routes_13r_plot) + 
  geom_smooth(span = 0.2, aes(cyc_dist_km,
                              trips_cyc_enmac10_1,
                              color="ENMAC 10%", 
                              group =1,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac10_1))) + 
  # geom_smooth(span = 0.2, aes(cyc_dist_km,
  #                             cumsum(trips_cyc_enmac10_1),
  #                             color="ENMAC 10%", 
  #                             group =1,
  #                             text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac10_1)), 
  #             linetype = "dashed") +
  geom_smooth(span = 0.2, aes(cyc_dist_km,
                              trips_cyc_enmac4_1,
                              color="ENMAC 4%",
                              group =2,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac4_1))) +
  # geom_smooth(span = 0.2, aes(cyc_dist_km,
  #                             cumsum(trips_cyc_enmac4_1),
  #                             color="ENMAC 4%",
  #                             group =2,
  #                             text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac4_1)), 
  #             linetype = "dashed") +
  geom_smooth(span = 0.3, aes(cyc_dist_km,
                              trips_cyc_enmac10_3,
                              color="Intermodal ENMAC 10%", 
                              group =1,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac10_3))) +
  # geom_smooth(span = 0.3, aes(cyc_dist_km,
  #                             cumsum(trips_cyc_enmac10_3),
  #                             color="Intermodal ENMAC 10%", 
  #                             group =1,
  #                             text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac10_3)), 
  #             linetype = "dashed") +
  geom_smooth(span = 0.3, aes(cyc_dist_km,
                              trips_cyc_enmac4_3,
                              color="Intermodal ENMAC 4%",
                              group =2,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac4_3))) +
  # geom_smooth(span = 0.3, aes(cyc_dist_km,
  #                             cumsum(trips_cyc_enmac4_3),
  #                             color="Intermodal ENMAC 4%",
  #                             group =2,
  #                             text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac4_3)), 
  #             linetype = "dashed")  +
  geom_smooth(span = 0.2, aes(cyc_dist_km,
                              trips_cyc_baseline_1,
                              color="IMOB 2018", 
                              group =3,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_baseline_1))) +
  # geom_smooth(span = 0.2, aes(cyc_dist_km,
  #                             cumsum(trips_cyc_baseline_1),
  #                             color="IMOB 2018", 
  #                             group =3,
  #                             text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_baseline_1)), 
  #             linetype = "dashed") +
  scale_y_continuous("Viagens em bicictela /dia", labels = label_number(suffix = " k", scale = 1e-3)) +
  scale_x_continuous("Distância de viagem (km)", breaks = seq(0,30, by=5)) +
  labs(title="", color='Cenário') +
  theme_minimal() +  
  guides(color=guide_legend(override.aes=list(fill=NA)), lty=guide_legend(override.aes=list(fill=NA))) +# removes the grey background in legend categories 
  scale_color_manual(values = c("blue", "darkgreen", "black", "red", "orange"))
  # scale_linetype_manual(name = "valor", values = c("solid", "dashed"), labels = c("as it is", "comulativo")) #tipo de linha
# ggplotly(p2) %>% config(displaylogo = FALSE) %>% 
#   layout(hovermode = "x") %>% style(hoverinfo = "y")

```
```{r plottly2}
# gráfico com caracterização viagens IMOB intra municipais e intermonicipais


p3 = ggplot(routes_13r_plot) + 
  geom_smooth(span = 0.2, aes(cyc_dist_km,
                              cumsum(trips_cyc_enmac10_1),
                              color="ENMAC 10%",
                              group =1,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac10_1)),
              linetype = "dashed") +
  geom_smooth(span = 0.2, aes(cyc_dist_km,
                              cumsum(trips_cyc_enmac4_1),
                              color="ENMAC 4%",
                              group =2,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac4_1)),
              linetype = "dashed") +
  geom_smooth(span = 0.3, aes(cyc_dist_km,
                              cumsum(trips_cyc_enmac10_3),
                              color="Intermodal ENMAC 10%",
                              group =1,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac10_3)),
              linetype = "dashed") +
  geom_smooth(span = 0.3, aes(cyc_dist_km,
                              cumsum(trips_cyc_enmac4_3),
                              color="Intermodal ENMAC 4%",
                              group =2,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_enmac4_3)),
              linetype = "dashed")  +
  geom_smooth(span = 0.2, aes(cyc_dist_km,
                              cumsum(trips_cyc_baseline_1),
                              color="IMOB 2018", 
                              group =3,
                              text = paste("Distancia:", cyc_dist_km, "<br>Viagens em bicicleta:", trips_cyc_baseline_1)), 
              linetype = "dashed") +
  scale_y_continuous("Viagens em bicictela /dia (cumulativo)", labels = label_number(suffix = " k", scale = 1e-3)) +
  scale_x_continuous("Distância de viagem (km)", breaks = seq(0,30, by=5)) +
  labs(title="", color='Cenário') +
  theme_minimal() +  
  guides(color=guide_legend(override.aes=list(fill=NA)), lty=guide_legend(override.aes=list(fill=NA))) +
  scale_color_manual(values = c("blue", "darkgreen", "black", "red", "orange"))

```
```{r sideplottly}
plotly::subplot(p2, p3, shareX = TRUE, titleY = TRUE) %>% 
  config(displaylogo = FALSE) %>% 
  layout(hovermode = "x") %>%
  style(hoverinfo = "y")
```

As linhas a tracejado representam os valores comulativos de número de viagens em bicicleta por dia do IMOB, para cada distância. Como se pode observar, o maior potencial de viagens em bicicleta situa-se em viagens até 10 km, sendo que os primeiros 5 km são muito expressivos, e os ganhos potenciais após os 10 km são residuais.

<details>
  <summary>**Porque é que não ha viagens com mais de 12 km no cenário intermodal?**</summary>
Esta limitação tem a ver com a forma como foram estimadas as viagens passíveis de serem realizadas em bicicleta nos vários cenários, em que no cenário intermodal considerámos uma duração máxima razoável de 2 horas. A soma das distâncias e durações da primeira e última _milha_ ("em cima de uma bicicleta") nessas viagens não ultrapassa os 12 km.
</details>

## Rede ciclável potencial

Os mapas seguintes mostram as ligações cicláveis com maior potencial, para o **cenário base** (viagens do IMOB 2018), para **4%** de viagens em bicicleta (meta 2024), e para **10%** de viagens em bicicleta (meta 2030), transferidas diretamente de viagens em automóvel.

Cada mapa refere-se a cada uma das 3 estimativas:

* viagens até 5 km com ligação em bicicleta (_`r fmt_num(HEAT_aml_redux[4,13])` viagens `r stringr::str_to_lower(proposicao)` `r mun`_)
* viagens até 10 km com ligação em bicicleta elétrica (_`r fmt_num(HEAT_aml_redux[8,13])` viagens `r stringr::str_to_lower(proposicao)` `r mun`_)
* viagens até 5 km em bicicleta de ou até uma interface de transportes (_`r fmt_num(HEAT_aml_redux[12,13])` viagens `r stringr::str_to_lower(proposicao)` `r mun`_)

<!-- Passar isto para FAQ? -->

<details>
  <summary>**Como ler estes mapas?**</summary>
Os mapas apresentam a informação gráfica para duas redes - a rede ciclável para viagens mais diretas, e a rede para viagens mais seguras e tranquilas (conforme a rede viária existente).  
A largura das linhas varia consoante o número de ciclistas potencial para cada um dos cenários (4% e 10% de ciclistas), e essa informação é visível ao passar com o rato em cima da linha.  
A cor das linhas varia com o nível de tranquilidade ([_quietness_](https://www.cyclestreets.net/help/journey/howitworks/#quietness){target="_blank"}), sendo as mais escuras aquelas menos seguras para circular em bicicleta - indicando com maior clareza quais os segmentos que necessitam de intervenção para se tornarem mais seguros e potencialmente trazerem mais ciclistas: os **mais escuros e mais largos**.

Ao clicar em cada linha, uma janela abre-se com mais informação sobre as viagens estimadas que podem passar por aquele segmento, incluindo os benefícios sociais e ambientais estimados, e as características físicas daquele segmento.

É possível ver mais do que uma opção de rota em simultâneo (direta / segura), por exemplo para comparar alternativas, e níveis de potencial ciclável, estabelecidos pela Estratégia Nacional de Mobilidade Ativa Ciclável ([ENMAC](https://files.dre.pt/1s/2019/08/14700/0004600081.pdf){target="_blank"}), em 4 e 10% nos centros urbanos, transferidos de viagens em automóvel. 
</details>

#### Até 5 km

Este mapa apresenta os segmentos com mais de `r minimo1` viagens potenciais em bicicleta. Para um maior ou menor detalhe da rede, ver a secção de [Downloads].

```{r mapa1, cache=FALSE, eval=FALSE}
m1 = tmap::tm_shape(mapa11r, name = "Potencial 4% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  # "Em bicicleta 2018" = "Bike",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  # "Novos ciclistas 4%" = "new_cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-linear_yl_rd_bk", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa11l, name = "Potencial 4% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-mako", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa12r, name = "Potencial 10% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-linear_yl_rd_bk",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tmap::tm_shape(mapa12l, name = "Potencial 10% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-mako",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tm_view(view.legend.position = c("right", "bottom"),
          control.position = c("right", "top")
          # title = "Viagens até 5 km em bicicleta"
          # leaflet.options = highlightOptions(color = "white", bringToFront = TRUE)
          )
m1leaf = tmap::tmap_leaflet(m1) %>% 
  leaflet::addProviderTiles("Esri.WorldImagery", group = "Satelite") %>% 
  leaflet::addLayersControl(baseGroups = c("Esri.WorldGrayCanvas", "OpenStreetMap", "Satelite"),
                            overlayGroups = c("Potencial 4% - direto", "Potencial 10% - direto", 
                                              "Potencial 4% - seguro", "Potencial 10% - seguro"),
                            options = layersControlOptions(collapsed = FALSE)) %>% 
  leaflet::hideGroup(c("Potencial 10% - direto", "Potencial 4% - seguro", "Potencial 10% - seguro"))


m1leaf

```

[![Mapa AML cenário 1](img/aml_cenario1_cover.png)](mapa_cenario1.html){target="_blank"}

> Ver o mapa em [ecrã inteiro](mapa_cenario1.html){target="_blank"}.

#### Até 10 km (e-bike)

Este mapa mostra os segmentos com mais de `r minimo2` viagens potenciais em bicicleta elétrica. Para um maior ou menor detalhe da rede, ver a secção de [Downloads].

```{r mapa2, cache=FALSE, eval=FALSE}
m2 = tmap::tm_shape(mapa21r, name = "Potencial 4% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  # "Em bicicleta 2018" = "Bike",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  # "Novos ciclistas 4%" = "new_cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-reds3", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa21l, name = "Potencial 4% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-hokusai2", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa22r, name = "Potencial 10% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-reds3",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tmap::tm_shape(mapa22l, name = "Potencial 10% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-hokusai2",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tm_view(view.legend.position = c("right", "bottom"),
          control.position = c("right", "top")
          # title = "Viagens até 5 km em bicicleta"
          # leaflet.options = highlightOptions(color = "white", bringToFront = TRUE)
          )
m2leaf = tmap::tmap_leaflet(m2) %>% 
  leaflet::addProviderTiles("Esri.WorldImagery", group = "Satelite") %>% 
  leaflet::addLayersControl(baseGroups = c("Esri.WorldGrayCanvas", "OpenStreetMap", "Satelite"),
                            overlayGroups = c("Potencial 4% - direto", "Potencial 10% - direto", 
                                              "Potencial 4% - seguro", "Potencial 10% - seguro"),
                            options = layersControlOptions(collapsed = FALSE)) %>% 
  leaflet::hideGroup(c("Potencial 10% - direto", "Potencial 4% - seguro", "Potencial 10% - seguro"))


m2leaf

```

[![Mapa AML cenário 2](img/aml_cenario2_cover.png)](mapa_cenario2.html){target="_blank"}

> Ver o mapa em [ecrã inteiro](mapa_cenario2.html){target="_blank"}.

#### Até 5 km intermodal

Este mapa mostra os segmentos com mais de `r minimo3` viagens potenciais em bicicleta, em que parte da viagem é realizada em transportes públicos (barco, comboio, metro sul do Tejo, ou carris metropolitana). Os segmentos deste mapa dizem respeito apenas à parte da viagem que é realizada em bicicleta, num total de até 5 km no conjunto da primeira e última etapa da viagem intermodal. Para um maior ou menor detalhe da rede, ver a secção de [Downloads].

```{r mapa3, cache=FALSE}
mapa31r = mapa31r %>% filter(cyc < 2400) #otherwise we cant see scale lwd
mapa31l = mapa31l %>% filter(cyc < 2400) #otherwise we cant see scale lwd
mapa32r = mapa32r %>% filter(cyc < 5400) #otherwise we cant see scale lwd
mapa32l = mapa32l %>% filter(cyc < 5400) #otherwise we cant see scale lwd

m3 = tmap::tm_shape(mapa31r, name = "Potencial 4% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 30,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  # "Em bicicleta 2018" = "Bike",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  # "Novos ciclistas 4%" = "new_cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-burg", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa31l, name = "Potencial 4% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 40,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-dark_mint", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa32r, name = "Potencial 10% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 30,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-burg",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tmap::tm_shape(mapa32l, name = "Potencial 10% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 40,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-dark_mint",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tm_view(view.legend.position = c("right", "bottom"),
          control.position = c("right", "top")
          # title = "Viagens até 5 km em bicicleta"
          # leaflet.options = highlightOptions(color = "white", bringToFront = TRUE)
          )
m3leaf = tmap::tmap_leaflet(m3) %>% 
  leaflet::addProviderTiles("Esri.WorldImagery", group = "Satelite") %>% 
  leaflet::addLayersControl(baseGroups = c("Esri.WorldGrayCanvas", "OpenStreetMap", "Satelite"),
                            overlayGroups = c("Potencial 4% - direto", "Potencial 10% - direto", 
                                              "Potencial 4% - seguro", "Potencial 10% - seguro"),
                            options = layersControlOptions(collapsed = FALSE)) %>% 
  leaflet::hideGroup(c("Potencial 10% - direto", "Potencial 4% - seguro", "Potencial 10% - seguro"))


m3leaf

```

Ver mapa em [ecrã inteiro](mapa_cenario3.html){target="_blank"}.

```{r exportmaps}
htmlwidgets::saveWidget(m1leaf, file = paste0("biclarwww/", i,"/mapa_cenario1.html"))

htmlwidgets::saveWidget(m2leaf, file = paste0("biclarwww/", i,"/mapa_cenario2.html"))

htmlwidgets::saveWidget(m3leaf, file = paste0("biclarwww/", i,"/mapa_cenario3.html"))
```


## Resumo

A tabela mostra o potencial ciclável `r stringr::str_to_lower(proposicao)` `r mun` em número de novas viagens em bicicleta potenciais, para cada meta da Estratégia Nacional ENMAC, para cada cenário, e para cada tipo de rotas otimizadas. 

Para cada um destes cenários, é possível ver também de forma agregada qual o benefício potencial estimado, em toneladas de CO~2~eq evitado anualmente, e em benefícios sociais.

<details>
  <summary>**Como são estimados os benefícios sociais e ambientais?**</summary>
Os benefícios potenciais são estimados em duas vertentes, utilizando os métodos e a ferramenta [_HEAT for Cycling_](https://www.heatwalkingcycling.org/){target="_blank"}, da Organização Mundial de Saúde.

A componente ambiental é medida em toneladas de CO~2~eq evitado, por transferência de viagens equivalentes em automóvel, com a mesma origem e destino, mas não necessariamente com o mesmo percurso.

Os impactes sociais agregados, na componente da saúde, são estimados em termos de redução/aumento da mortalidade por aumento de atividade física, por exposição à poluição atomosférica, e por exposição ao risco de sinistralidade rodoviária.  
Este valor é por fim monetizado utilizando o _Valor Estatístico da Vida_ (€3.055.358, segundo [ANSR 2021](http://www.ansr.pt/Estatisticas/RelatoriosTematicos/Documents/O%20Impacto%20Economico%20e%20Social%20da%20Sinistralidade%20-%20PT.pdf){target="_blank"}), estimado para 10 anos, com uma taxa de desconto de 5% e inflação de 3%. 
</details>



```{r tabela}
# tabela com potencial para cada cenario +  estimativas SE

tabelas_aml = readRDS("HEAT/tabelas_aml.Rds")
tabelas_aml$Estrategia = gsub("ate", "até", tabelas_aml$Estrategia)
tabelas_aml = tabelas_aml %>%
  mutate(Percursos = recode(LTS, `3` = "seguro", `4` = "direto")) %>% 
  select(c(3,1,10,5:9)) %>% 
  arrange(Meta_ENMAC)

DT::datatable(tabelas_aml,
                filter = 'none',
                rownames = FALSE,
                colnames = c("Meta ENMAC", "Cenário", "Tipo de Percurso", "Total Viagens /dia",
                             "Viagens Bicicleta 2018", "Viagens Bicicleta Potencial",
                             "CO2eq evitado (ton/ano)", "Benefícios estimados em 10 anos (milhares €)"),
                extensions = c("RowGroup", "Buttons"),
                options = list(dom = "tB",
                               buttons = list(list(extend='copy',text="Copiar"), "excel"),
                               pageLength = 12,
                               responsive = TRUE,
                               rowGroup = list(dataSrc = 0), #agrupar a primeira coluna
                               extensions = c('Responsive'))) %>% 
    DT::formatRound(c(4:8),0, mark = " ")

cicmacx4 = max(tabelas_aml$Bike_new[tabelas_aml$Meta_ENMAC=="4%"])
cicmacx10 = max(tabelas_aml$Bike_new[tabelas_aml$Meta_ENMAC=="10%"])
co2macx4 = max(tabelas_aml$CO2eq[tabelas_aml$Meta_ENMAC=="4%"])
co2macx10 = max(tabelas_aml$CO2eq[tabelas_aml$Meta_ENMAC=="10%"])
euromacx4 = max(tabelas_aml$Economic10[tabelas_aml$Meta_ENMAC=="4%"])
euromacx10 = max(tabelas_aml$Economic10[tabelas_aml$Meta_ENMAC=="10%"])

```

`r proposicao` `r mun`, a **meta de 4%** de ciclistas diários equivale a ter **`r fmt_num(cicmacx4/1000)` mil ciclistas** em viagens até 10 km, com uma redução potencial de **`r fmt_num(co2macx4/1000)` mil toneladas** de CO~2~eq por ter menos viagens em automóvel na mesma razão, com potenciais benefícios para a sociedade de **`r fmt_num(euromacx4/1000)` milhões €** ao fim de 10 anos.  

Já a **meta de 10%** de ciclistas diários equivale a ter **`r fmt_num(cicmacx10/1000)` mil ciclistas** em viagens até 10 km, com uma redução potencial de **`r fmt_num(co2macx10/1000)` mil toneladas** de CO~2~eq por ter menos viagens em automóvel na mesma razão, com potenciais benefícios para a sociedade de **`r round(euromacx10/1000000, 1)` mil milhões €** ao fim de 10 anos.


Relativamente ao cenário 3, de transferência modal de viagens em automóvel que são passíveis de serem realizadas em **intermodalidade entre bicicleta + transportes públicos** (viáveis), e cuja distância em bicicleta não é superior a 5km no total da primeira e última parte da viagem, a tabela seguinte mostra o potencial de transferência estimado para cada modo de transporte público, bem como as **estimativas de consumo de CO~2~eq evitado anualmente** por trasferência do automóvel, considerando também o consumo dos transportes públicos, no cômputo dessas viagens.

```{r tabela2}
CAR_TP_TRANSF = readRDS("HEAT/CAR_TP_TRANSF.Rds")
HEAT_aml_results2 = readRDS("HEAT/HEAT_aml_results.Rds")

TPtable_car = CAR_TP_TRANSF %>%
  group_by(LTS, mode_TP) %>% 
  summarise(TP_4 = sum(TP_4), TP_10 = sum(TP_10)) %>% 
  ungroup() %>% 
  pivot_longer(c(3,4), names_to = "ENMAC", values_to = "viagens") %>% 
  pivot_wider(names_from = mode_TP, values_from = viagens) %>% 
  mutate (Total = rowSums(.[3:6])) %>% 
  as.data.frame()

TPtable_aml = HEAT_aml_results %>% 
  filter(Estrategia == "intermodal ate 5km ") %>% 
  select(33:40) %>%
  bind_cols(TPtable_car) %>% 
  select(`LTS...1`, Meta_ENMAC, Total, FERRY, RAIL, BUS, TRAM,
         CO2eq_TP, CO_PT, PM10_PT, NOx_PT, VOC_PT, money_emissions_eur) %>%
  mutate(Percursos = recode(`LTS...1`, `3` = "seguro", `4` = "direto")) %>% 
  select(14, 2:13) %>% 
  data.frame()


sketch2 = htmltools::withTags(table( #repetir header
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Tipo de Percurso'),
      th(rowspan = 2, 'Meta ENMAC'),
      th(colspan = 5, 'Viagens TP em complemento com bicicleta'),
      th(colspan = 5, 'Emissões evitadas por substituição do automóvel (ton / ano)'),
      th(rowspan = 2, 'Valorização monetária (€)')
    ),
    tr(
      lapply(rep(c("Total", "Barco", "Comboio", "Autocarro", "Metro superfície",
                   "CO2eq", "CO", "PM10", "NOx", "VOC"), 1), th)
    )
  )
))


  
DT::datatable(TPtable_aml,
                filter = 'none',
                rownames = FALSE,
                container = sketch2,
                # colnames = c("Tipo de Percurso", "Meta ENMAC",  "Total", "Barco", "Comboio", "Autocarro",
                #              "Metro superfície", "CO2eq", "CO", "PM10", "NOx", "VOC",
                #              "Valorização monetária (€)"),
                extensions = c("RowGroup", "Buttons"),
                options = list(dom = "tB",
                               buttons = list(list(extend='copy',text="Copiar"), "excel"),
                               pageLength = 4,
                               responsive = TRUE,
                               extensions = c('Responsive'))) %>% 
    DT::formatRound(c(3:9,11,13),0, mark = " ") %>% 
    DT::formatRound(c(10,12),1)
 

```

Estes resultados indicam que a transferência da viagem em automóvel para bicicleta + transportes públicos, dentro dos critétrios considerados (max 5km em bicicleta na soma da primeira e última _milha_, e sem transferências de modo ou linha), poderá ter **benefícios potenciais estimados entre `r round(TPtable_aml[1,13]/1000000,1)` e `r round(TPtable_aml[4,13]/1000000,1)` milhões de €**.

Neste cenário, `r fmt_num(round(min(TPtable_aml$Total/1000)))`mil a `r fmt_num(round(max(TPtable_aml$Total/1000)))`mil viagens podem ser substituídas do automóvel para Bicicleta + Transportes Públicos.

O modo com maior potencial de transferência modal, em complemento com a bicicleta, é o **comboio**, com `r round(TPtable_aml[2,5]/1000)`mil viagens

## Downloads

```{r downloads}

path_sf_1r = paste0(i, "_rededireta_cenario1.gpkg") 
path_sf_1l = paste0(i, "_redesegura_cenario1.gpkg")

path_sf_2r = paste0(i, "_rededireta_cenario2.gpkg")
path_sf_2l = paste0(i, "_redesegura_cenario2.gpkg")

path_sf_3r = paste0(i, "_rededireta_cenario3.gpkg")
path_sf_3l = paste0(i, "_redesegura_cenario3.gpkg")

```


Os mapas acima estão disponíveis para download, em formato _GeoPackage_ (.gpkg), que pode ser ligo em qualquer SIG moderno. É recomendável o software de acesso livre [QGIS](https://qgis.org/pt_PT/site/){target="_blank"} para leitura, visualização e análise de dados em detalhe.

1.    **Viagens até 5 km em bicicleta**

  *   [Rede direta](`r path_sf_1r`)
  *   [Rede segura](`r path_sf_1l`)
    
2.    **Viagens até 10 km em bicicleta elétrica**

  *   [Rede direta](`r path_sf_2r`)
  *   [Rede segura](`r path_sf_2l`)
    
3.    **Viagens intermodais até 5 km em bicicleta**

  *   [Rede direta](`r path_sf_3r`)
  *   [Rede segura](`r path_sf_3l`)


`r emo::ji("magnifying")` A rede disponibilizada poderá não corresponder à que é apresentada nos mapas acima, que mostram apenas os segmentos com mais de X viagens potenciais em bicicleta. Para visualizar os segmentos dependendo do número de viagens potenciais, utilizar os filtros do SIG, por exemplo, para visualizar só os segmentos com mais de 500 viagens, ou todos os segmentos com mais de 10 viagens em bicicleta.

#### Rede ciclável existente e prevista

É também disponibilizado um [mapa da rede ciclável existente e prevista](https://ushift.tecnico.ulisboa.pt/content/tml/RedeExistentePrevista.html){target="_blank"} na AML em **Julho 2022**, e os seus ficheiros para transferência:

*   [Rede ciclável existente, por tipologia](https://ushift.tecnico.ulisboa.pt/content/tml/RedeExistente.gpkg)
*   [Rede ciclável prevista](https://ushift.tecnico.ulisboa.pt/content/tml/RedePrevista.gpkg)

