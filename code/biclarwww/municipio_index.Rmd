---
title: "Resultados por município"
output:
  html_document:
    theme:
      bg: "#FFFFFF"
      fg: "#000000"
      highlight: "#000000"
      primary: "#000000"
      base_font:
        google: "Lexend"
      code_font:
        google: "JetBrains Mono"
    css: css/style.css
    includes:
      after_body: img/footer.html
---
  

```{r setup, include=FALSE}
library(dplyr)
library(tmap)
tmap_mode("view")
library(leaflet)

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

fmt_num = function(x) format(round(sum(x)), big.mark=" ")
```

```{r chamadas}
i = "barreiro" #delete this when running for all!!!
mun = stringr::str_to_title(i)

if (i == "vila franca de xira") {
    i = "vfxira"
  }

proposicao = ifelse(mun %in% c("Amadora", "Moita"), "Na",
                    ifelse(mun %in% c("Barreiro", "Montijo", "Seixal"), "No",
                           "Em"))
proposicaoD = ifelse(mun %in% c("Amadora", "Moita"), "da",
                    ifelse(mun %in% c("Barreiro", "Montijo", "Seixal"), "do",
                           "de"))
```

```{r}
MUNICIPIOSgeo = readRDS(url("https://github.com/U-Shift/biclar/releases/download/0.0.1/MUNICIPIOSgeo.Rds"))

HEAT_municipios_redux = readRDS(url("https://github.com/U-Shift/biclar/releases/download/0.0.1/HEAT_municipios_123_redux.Rds"))
HEAT_mun = HEAT_municipios_redux %>% filter(Municipio == mun)

# cenario 1

if (i %in% c("mafra", "sesimbra", "alcochete", "palmela")){

  mapa11r = sf::st_read("export_rnet/rnet_aml_1404_15.gpkg", quiet = TRUE)
  mapa11r = mapa11r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
    mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
  mapa11l = sf::st_read("export_rnet/rnet_aml_1304_15.gpkg", quiet = TRUE)
  mapa11l = mapa11l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
    mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
  mapa12r = sf::st_read("export_rnet/rnet_aml_1410_15.gpkg", quiet = TRUE)
  mapa12r = mapa12r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
    mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
  mapa12l = sf::st_read("export_rnet/rnet_aml_1310_15.gpkg", quiet = TRUE)
  mapa12l = mapa12l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
    mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
  
} else {

mapa11r = sf::st_read("export_rnet/rnet_aml_1404_50.gpkg", quiet = TRUE)
mapa11r = mapa11r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa11l = sf::st_read("export_rnet/rnet_aml_1304_50.gpkg", quiet = TRUE)
mapa11l = mapa11l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa12r = sf::st_read("export_rnet/rnet_aml_1410_50.gpkg", quiet = TRUE)
mapa12r = mapa12r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa12l = sf::st_read("export_rnet/rnet_aml_1310_50.gpkg", quiet = TRUE)
mapa12l = mapa12l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))

}


# cenario 2

if (i %in% c("mafra", "sesimbra", "alcochete", "palmela")){

mapa21r = sf::st_read("export_rnet/rnet_aml_1404_50.gpkg", quiet = TRUE)
mapa21r = mapa21r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa21l = sf::st_read("export_rnet/rnet_aml_1304_50.gpkg", quiet = TRUE)
mapa21l = mapa21l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa22r = sf::st_read("export_rnet/rnet_aml_1410_50.gpkg", quiet = TRUE)
mapa22r = mapa22r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa22l = sf::st_read("export_rnet/rnet_aml_1310_50.gpkg", quiet = TRUE)
mapa22l = mapa22l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))

} else if (i %in% c("almada", "oeiras", "lisboa", "odivelas", "amadora")){

mapa21r = sf::st_read("export_rnet/rnet_aml_1404_200.gpkg", quiet = TRUE)
mapa21r = mapa21r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa21l = sf::st_read("export_rnet/rnet_aml_1304_200.gpkg", quiet = TRUE)
mapa21l = mapa21l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa22r = sf::st_read("export_rnet/rnet_aml_1410_200.gpkg", quiet = TRUE)
mapa22r = mapa22r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa22l = sf::st_read("export_rnet/rnet_aml_1310_200.gpkg", quiet = TRUE)
mapa22l = mapa22l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))

} else {

mapa21r = sf::st_read("export_rnet/rnet_aml_1404_100.gpkg", quiet = TRUE)
mapa21r = mapa21r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa21l = sf::st_read("export_rnet/rnet_aml_1304_100.gpkg", quiet = TRUE)
mapa21l = mapa21l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa22r = sf::st_read("export_rnet/rnet_aml_1410_100.gpkg", quiet = TRUE)
mapa22r = mapa22r[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa22l = sf::st_read("export_rnet/rnet_aml_1310_100.gpkg", quiet = TRUE)
mapa22l = mapa22l[MUNICIPIOSgeo %>% filter(Concelho == mun) %>% sf::st_buffer(300), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))

}



# cenario 3

if (i %in% c("lisboa", "almada", "cascais", "amadora", "sintra", "oeiras")){
  
  mapa31r = sf::st_read("export_rnet/rnet_aml_3404_30.gpkg", quiet = TRUE)
mapa31r = mapa31r[MUNICIPIOSgeo %>% filter(Concelho == mun), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa31l = sf::st_read("export_rnet/rnet_aml_3304_30.gpkg", quiet = TRUE)
mapa31l = mapa31l[MUNICIPIOSgeo %>% filter(Concelho == mun), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa32r = sf::st_read("export_rnet/rnet_aml_3410_30.gpkg", quiet = TRUE)
mapa32r = mapa32r[MUNICIPIOSgeo %>% filter(Concelho == mun), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa32l = sf::st_read("export_rnet/rnet_aml_3310_30.gpkg", quiet = TRUE)
mapa32l = mapa32l[MUNICIPIOSgeo %>% filter(Concelho == mun), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
  
  
} else {

mapa31r = sf::st_read("export_rnet/rnet_aml_3404_10.gpkg", quiet = TRUE)
mapa31r = mapa31r[MUNICIPIOSgeo %>% filter(Concelho == mun), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa31l = sf::st_read("export_rnet/rnet_aml_3304_10.gpkg", quiet = TRUE)
mapa31l = mapa31l[MUNICIPIOSgeo %>% filter(Concelho == mun), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa32r = sf::st_read("export_rnet/rnet_aml_3410_10.gpkg", quiet = TRUE)
mapa32r = mapa32r[MUNICIPIOSgeo %>% filter(Concelho == mun), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))
mapa32l = sf::st_read("export_rnet/rnet_aml_3310_10.gpkg", quiet = TRUE)
mapa32l = mapa32l[MUNICIPIOSgeo %>% filter(Concelho == mun), , op = sf::st_within] %>% 
  mutate(tCO2eq = tCO2eq10/10,
         quietness = as.integer(quietness), #não funciona pra efeitos da legenda
         bike18 = paste0("(", Bikeper, ") ", Bike))

}

```

```{r minimos}
if (i %in% c("mafra", "sesimbra", "alcochete", "palmela")){ 
  minimo1 = 15} else {
    minimo1 = 50 
  }

if (i %in% c("mafra", "sesimbra", "alcochete", "palmela")){ 
  minimo2 = 50} else if (i %in% c("almada", "oeiras", "lisboa", "odivelas", "amadora")){
    minimo2 = 200 } else {
    minimo2 = 100
  }

if (i %in% c("lisboa", "almada", "cascais", "amadora", "sintra", "oeiras")){
  minimo3 = 30} else {
    minimo3 = 10
  }

```



<!-- landing page for each municipio -->

# `r mun`

`r proposicao` `r mun`, as viagens são assim.

Os mapas seguintes mostram as ligações cicláveis com maior potencial, para o **cenário base** (viagens do IMOB 2018), para **4%** de viagens em bicicleta (meta 2024), e para **10%** de viagens em bicicleta (meta 2030), transferidas diretamente de viagens em automóvel.

Cada mapa refere-se a cada uma das 3 estimativas:

* viagens até 5 km com ligação em bicicleta (_`r fmt_num(HEAT_mun[4,14])` viagens `r stringr::str_to_lower(proposicao)` `r mun`_)
* viagens até 10 km com ligação em bicicleta elétrica (_`r fmt_num(HEAT_mun[8,14])` viagens `r stringr::str_to_lower(proposicao)` `r mun`_)
* viagens até 5 km em bicicleta de ou até uma interface de transportes (_`r fmt_num(HEAT_mun[12,14])` viagens `r stringr::str_to_lower(proposicao)` `r mun`_)

<!-- Passar isto para FAQ? -->
Os mapas apresentam a informação gráfica para duas redes - a rede ciclável para viagens mais diretas, e a rede para viagens mais seguras e tranquilas (conforme a rede viária existente). A largura das linhas varia consoante o número de ciclistas potencial para cada um dos cenários (4% e 10% de ciclistas), e essa informação é visível ao passar com o rato em cima da linha.  
A cor das linhas varia com o nível de tranquilidade ([_quietness_](https://www.cyclestreets.net/help/journey/howitworks/#quietness)), sendo as mais escuras aquelas menos seguras para circular em bicicleta - indicando com maior clareza quais os segmentos que necessitam de intervenção para se tornarem mais seguros e potencialmente trazerem mais ciclistas: os **mais escuros e mais largos**.

Ao clicar em cada linha, uma janela abre-se com mais informação sobre as viagens estimadas que podem passar por aquele segmento, incluindo os benefícios socio-ambientais estimados, e as características físicas daquele segmento.

É possível ver mais do que uma opção de rota em simultâneo (direta / segura), por exemplo para comparar alternativas, e níveis de potencial ciclável, estabelecidos pela Estratégia Nacionail de Mobilidade Ativa Ciclável ([ENMAC](https://files.dre.pt/1s/2019/08/14700/0004600081.pdf)), em 4 e 10% nos centros urbanos, transferidos de viagens em automóvel. 

### Até 5 km

```{r mapa1}
m1 = tmap::tm_shape(mapa11r, name = "Potencial 4% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  # "Em bicicleta 2018" = "Bike",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  # "Novos ciclistas 4%" = "new_cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-linear_yl_rd_bk", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa11l, name = "Potencial 4% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-mako", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa12r, name = "Potencial 10% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-linear_yl_rd_bk",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tmap::tm_shape(mapa12l, name = "Potencial 10% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-mako",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tm_view(view.legend.position = c("right", "bottom"),
          control.position = c("right", "top")
          # title = "Viagens até 5 km em bicicleta"
          # leaflet.options = highlightOptions(color = "white", bringToFront = TRUE)
          )
m1leaf = tmap::tmap_leaflet(m1) %>% 
  leaflet::addProviderTiles("Esri.WorldImagery", group = "Satelite") %>% 
  leaflet::addLayersControl(baseGroups = c("Esri.WorldGrayCanvas", "OpenStreetMap", "Satelite"),
                            overlayGroups = c("Potencial 4% - direto", "Potencial 10% - direto", 
                                              "Potencial 4% - seguro", "Potencial 10% - seguro"),
                            options = layersControlOptions(collapsed = FALSE)) %>% 
  leaflet::hideGroup(c("Potencial 10% - direto", "Potencial 4% - seguro", "Potencial 10% - seguro"))


m1leaf

htmlwidgets::saveWidget(m1leaf, file = paste0("biclarwww/", i,"/mapa_cenario1.html"))

```

Ver mapa em [ecrã inteiro](mapa_cenario1.html).

> Este mapa apresenta os segmentos com mais de `r minimo1` viagens potenciais em bicicleta. Para um maior ou menor detalhe da rede, ver a secção de [Downloads].


### Até 10 km (e-bike)

```{r mapa2}
m2 = tmap::tm_shape(mapa21r, name = "Potencial 4% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  # "Em bicicleta 2018" = "Bike",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  # "Novos ciclistas 4%" = "new_cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-linear_yl_rd_bk", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa21l, name = "Potencial 4% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-mako", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa22r, name = "Potencial 10% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-linear_yl_rd_bk",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tmap::tm_shape(mapa22l, name = "Potencial 10% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-mako",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tm_view(view.legend.position = c("right", "bottom"),
          control.position = c("right", "top")
          # title = "Viagens até 5 km em bicicleta"
          # leaflet.options = highlightOptions(color = "white", bringToFront = TRUE)
          )
m2leaf = tmap::tmap_leaflet(m2) %>% 
  leaflet::addProviderTiles("Esri.WorldImagery", group = "Satelite") %>% 
  leaflet::addLayersControl(baseGroups = c("Esri.WorldGrayCanvas", "OpenStreetMap", "Satelite"),
                            overlayGroups = c("Potencial 4% - direto", "Potencial 10% - direto", 
                                              "Potencial 4% - seguro", "Potencial 10% - seguro"),
                            options = layersControlOptions(collapsed = FALSE)) %>% 
  leaflet::hideGroup(c("Potencial 10% - direto", "Potencial 4% - seguro", "Potencial 10% - seguro"))


m2leaf

htmlwidgets::saveWidget(m2leaf, file = paste0("biclarwww/", i,"/mapa_cenario2.html"))

```

Ver mapa em [ecrã inteiro](mapa_cenario2.html).

> Este mapa mostra os segmentos com mais de `r minimo2` viagens potenciais em bicicleta. Para um maior ou menor detalhe da rede, ver a secção de [Downloads].

### Até 5 km intermodal

```{r mapa3}
m3 = tmap::tm_shape(mapa31r, name = "Potencial 4% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  # "Em bicicleta 2018" = "Bike",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  # "Novos ciclistas 4%" = "new_cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-burg", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa31l, name = "Potencial 4% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 12,
                   lwd_multiplier = 15,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 4%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0), #
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-dark_mint", n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   textNA = "sem info",
                   title.col = "Tranquilidade"
                   ) +
  tmap::tm_shape(mapa32r, name = "Potencial 10% - direto") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-burg",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tmap::tm_shape(mapa32l, name = "Potencial 10% - seguro") +
    tmap::tm_lines(id = "cyc",
                   lwd = "cyc",
                   alpha = 0.9,
                   scale = 15,
                   lwd_multiplier = 18,
                   popup.vars = c("Viagens 2018" = "Total",
                                  "Ciclistas cenário base" = "bike18",
                                  "Ciclistas cenário 10%" = "cyc",
                                  "Benefícios a 10 anos [milhares €]" = "Beneficios10_keuro",
                                  "CO2eq evitado [ton/ano]" = "tCO2eq",
                                  "Tranquilidade" = "quietness",
                                  "Velocidade auto [km/h]" = "carspeed",
                                  "Declive médio" = "slope"
                                  ),
                   popup.format = list(big.mark = " ", digits = 0),
                   col = "quietness",
                   palette = cols4all::c4a(palette = "-dark_mint",  n = 4),
                   breaks = c(0, 25, 50, 75, 100),
                   legend.format = list(text.separator = "a"),
                   legend.col.show = FALSE,
                   textNA = "sem info",
                   title.col = "Tranquilidade",
                   ) +
  tm_view(view.legend.position = c("right", "bottom"),
          control.position = c("right", "top")
          # title = "Viagens até 5 km em bicicleta"
          # leaflet.options = highlightOptions(color = "white", bringToFront = TRUE)
          )
m3leaf = tmap::tmap_leaflet(m3) %>% 
  leaflet::addProviderTiles("Esri.WorldImagery", group = "Satelite") %>% 
  leaflet::addLayersControl(baseGroups = c("Esri.WorldGrayCanvas", "OpenStreetMap", "Satelite"),
                            overlayGroups = c("Potencial 4% - direto", "Potencial 10% - direto", 
                                              "Potencial 4% - seguro", "Potencial 10% - seguro"),
                            options = layersControlOptions(collapsed = FALSE)) %>% 
  leaflet::hideGroup(c("Potencial 10% - direto", "Potencial 4% - seguro", "Potencial 10% - seguro"))


m3leaf

htmlwidgets::saveWidget(m3leaf, file = paste0("biclarwww/", i,"/mapa_cenario3.html"))

```

Ver mapa em [ecrã inteiro](mapa_cenario3.html).

> Este mapa mostra os segmentos com mais de `r minimo3` viagens potenciais em bicicleta. Para um maior ou menor detalhe da rede, ver a secção de [Downloads].


## Resumo

```{r}
# tabela com potencial para cada cenario +  estimativas SE
```


## Downloads

```{r}
download_folder = paste0("biclarwww/", i)

path_sf_1r = paste0(download_folder, "/", i, "_rededireta_cenario1.gpkg")
path_sf_1l = paste0(download_folder, "/", i, "_redesegura_cenario1.gpkg")

path_sf_2r = paste0(download_folder, "/", i, "_rededireta_cenario2.gpkg")
path_sf_2l = paste0(download_folder, "/", i, "_redesegura_cenario2.gpkg")

path_sf_3r = paste0(download_folder, "/", i, "_rededireta_cenario3.gpkg")
path_sf_3l = paste0(download_folder, "/", i, "_redesegura_cenario3.gpkg")

```


Os mapas acima estão disponíveis para download, em formato _GeoPackage_ (.gpkg), que pode ser ligo em qualquer SIG moderno. É recomendável o software de acesso livre [QGIS](https://qgis.org/pt_PT/site/) para leitura, visualização e análise de dados em detalhe.

1.    **Viagens até 5 km em bicicleta**
    *   [Rede direta](path_sf_1r)
    *   [Rede segura](path_sf_1l)
2.    **Viagens até 10 km em bicicleta elétrica**
    *   [Rede direta](path_sf_2r)
    *   [Rede segura](path_sf_2l)
3.    **Viagens intermodais até 5 km em bicicleta**
    *   [Rede direta](path_sf_3r)
    *   [Rede segura](path_sf_3l)

Para cada município, os dados disponíveis para download referem-se à rede ciclável potencial com um _buffer_ de 300 metros para além dos limites do município, para que sejam consideradas as ligações ao município vizinho. ( _Excepto no cenário 3_) 

A rede disponibilizada poderá não corresponder à que é apresentada nos mapas acima, que mostram apenas os segmentos com mais de X viagens potenciais em bicicleta. Para visualizar os segmentos dependendo do número de viagens potenciais, utilizar os filtros do SIG, por exemplo, para visualizar só os segmentos com mais de 500 viagens, ou todos os segmentos com mais de 10 viagens em bicileta.
